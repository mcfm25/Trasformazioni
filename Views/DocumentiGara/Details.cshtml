@model Trasformazioni.Models.ViewModels.DocumentoGara.DocumentoGaraDetailsViewModel

@{
    ViewData["Title"] = "Dettaglio Documento";
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item">
                <a asp-action="Index" asp-route-garaId="@Model.GaraId" asp-route-lottoId="@Model.LottoId">Documenti</a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">Dettaglio</li>
        </ol>
    </nav>

    <!-- Container per Alert Validazione -->
    <div id="validationAlertContainer"></div>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Header con Badge Tipo -->
    <div class="row mb-4">
        <div class="col-md-10">
            <h2>
                @{
                    var iconClass = Model.MimeType switch
                    {
                        var m when m.Contains("pdf") => "bi-file-earmark-pdf text-danger",
                        var m when m.Contains("word") || m.Contains("msword") => "bi-file-earmark-word text-primary",
                        var m when m.Contains("excel") || m.Contains("spreadsheet") => "bi-file-earmark-excel text-success",
                        var m when m.Contains("image") => "bi-file-earmark-image text-info",
                        var m when m.Contains("zip") || m.Contains("rar") => "bi-file-earmark-zip text-warning",
                        _ => "bi-file-earmark text-muted"
                    };
                }
                <i class="bi @iconClass me-2" style="font-size: 2rem;"></i>
                @Model.NomeFile
            </h2>
            @* @{
                var badgeClass = Model.Tipo switch
                {
                    Trasformazioni.Models.Enums.TipoDocumentoGara.DocumentoGeneraleGara => "bg-secondary",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.BandoOriginale => "bg-primary",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.Disciplinare => "bg-info",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.CapitolatoSpeciale => "bg-info",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.DocumentoValutazioneTecnica => "bg-success",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.DocumentoValutazioneEconomica => "bg-success",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.Preventivo => "bg-warning text-dark",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.DocumentoPresentazione => "bg-primary",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.OffertaTecnica => "bg-primary",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.OffertaEconomica => "bg-primary",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.RichiestaIntegrazioneEnte => "bg-danger",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.RispostaIntegrazione => "bg-success",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.ComunicazioneEnte => "bg-info",
                    Trasformazioni.Models.Enums.TipoDocumentoGara.Contratto => "bg-success",
                    _ => "bg-secondary"
                };
            } *@
            @{
                var badgeClass = Model.TipoDocumentoCodiceRiferimento switch
                {
                    "DocumentoGeneraleGara" => "bg-secondary",
                    "BandoOriginale" => "bg-primary",
                    "Disciplinare" => "bg-info",
                    "CapitolatoSpeciale" => "bg-info",
                    "DocumentoValutazioneTecnica" => "bg-success",
                    "DocumentoValutazioneEconomica" => "bg-success",
                    "Preventivo" => "bg-warning text-dark",
                    "DocumentoPresentazione" => "bg-primary",
                    "OffertaTecnica" => "bg-primary",
                    "OffertaEconomica" => "bg-primary",
                    "RichiestaIntegrazioneEnte" => "bg-danger",
                    "RispostaIntegrazione" => "bg-success",
                    "ComunicazioneEnte" => "bg-info",
                    "Contratto" => "bg-success",
                    _ => "bg-secondary"
                };
            }
            <p class="mb-0">
                <span class="badge @badgeClass">@Model.TipoDisplay</span>
                <span class="text-muted ms-2">@Model.DimensioneFormatted</span>
            </p>
        </div>
        <div class="col-md-2 text-end">
            <div class="btn-group-vertical">
                <a asp-action="Download" asp-route-id="@Model.Id" class="btn btn-primary">
                    <i class="bi bi-download me-1"></i>
                    Scarica
                </a>
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                    <i class="bi bi-pencil me-1"></i>
                    Modifica
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonna Sinistra -->
        <div class="col-md-8">
            
            <!-- Preview Documento (se supportato) -->
            @if (Model.CanPreview && Model.MimeType.Contains("pdf"))
            {
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-eye me-2"></i>
                            Anteprima Documento
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <iframe src="@Url.Action("ViewInline", new { id = Model.Id })" 
                                style="width: 100%; height: 600px; border: none;">
                        </iframe>
                    </div>
                </div>
            }
            else if (Model.CanPreview && Model.MimeType.Contains("image"))
            {
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-eye me-2"></i>
                            Anteprima Immagine
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <img src="@Url.Action("ViewInline", new { id = Model.Id })" 
                             class="img-fluid" 
                             alt="@Model.NomeFile"
                             style="max-height: 600px;" />
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <strong>Anteprima non disponibile</strong> per questo tipo di file.
                    <a asp-action="Download" asp-route-id="@Model.Id" class="btn btn-sm btn-primary ms-2">
                        <i class="bi bi-download me-1"></i>
                        Scarica per visualizzare
                    </a>
                </div>
            }

            <!-- Card Info Documento -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        Informazioni Documento
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Nome File:</dt>
                        <dd class="col-sm-8"><strong>@Model.NomeFile</strong></dd>

                        <dt class="col-sm-4">Tipo Documento:</dt>
                        <dd class="col-sm-8">
                            <span class="badge @badgeClass">@Model.TipoDisplay</span>
                        </dd>

                        <dt class="col-sm-4">Dimensione:</dt>
                        <dd class="col-sm-8">@Model.DimensioneFormatted</dd>

                        <dt class="col-sm-4">Formato:</dt>
                        <dd class="col-sm-8">
                            <code>@Model.MimeType</code>
                        </dd>

                        @if (!string.IsNullOrEmpty(Model.Descrizione))
                        {
                            <dt class="col-sm-4">Descrizione:</dt>
                            <dd class="col-sm-8">@Model.Descrizione</dd>
                        }

                        <dt class="col-sm-4">Data Caricamento:</dt>
                        <dd class="col-sm-8">@Model.DataCaricamento.ToString("dd/MM/yyyy HH:mm")</dd>
                    </dl>
                </div>
            </div>
        </div>

        <!-- Colonna Destra -->
        <div class="col-md-4">
            
            <!-- Card Associazioni -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg me-2"></i>
                        Associazioni
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.GaraId.HasValue)
                    {
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-folder text-primary me-1"></i>
                                Gara
                            </h6>
                            <p class="mb-1">
                                <a asp-controller="Gare" asp-action="Details" asp-route-id="@Model.GaraId">
                                    <strong>@Model.GaraCodice</strong>
                                </a>
                            </p>
                            @if (!string.IsNullOrEmpty(Model.GaraOggetto))
                            {
                                <p class="text-muted small mb-0">@Model.GaraOggetto</p>
                            }
                            @if (!string.IsNullOrEmpty(Model.GaraEnteDenominazione))
                            {
                                <p class="text-muted small mb-0">Ente: @Model.GaraEnteDenominazione</p>
                            }
                        </div>
                    }

                    @if (Model.LottoId.HasValue)
                    {
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-box text-secondary me-1"></i>
                                Lotto
                            </h6>
                            <p class="mb-1">
                                <a asp-controller="Lotti" asp-action="Details" asp-route-id="@Model.LottoId">
                                    <strong>@Model.LottoCodice</strong>
                                </a>
                            </p>
                            @if (!string.IsNullOrEmpty(Model.LottoDescrizione))
                            {
                                <p class="text-muted small mb-0">@Model.LottoDescrizione</p>
                            }
                        </div>
                    }

                    @if (Model.PreventivoId.HasValue)
                    {
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-file-earmark-text text-warning me-1"></i>
                                Preventivo
                            </h6>
                            <p class="mb-1">
                                <a asp-controller="Preventivi" asp-action="Details" asp-route-id="@Model.PreventivoId">
                                    Preventivo
                                </a>
                            </p>
                            @if (!string.IsNullOrEmpty(Model.PreventivoFornitore))
                            {
                                <p class="text-muted small mb-0">Fornitore: @Model.PreventivoFornitore</p>
                            }
                        </div>
                    }

                    @if (Model.IntegrazioneId.HasValue)
                    {
                        <div class="mb-3">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-arrow-repeat text-danger me-1"></i>
                                Richiesta Integrazione
                            </h6>
                            <p class="mb-1">
                                <a asp-controller="RichiesteIntegrazione" asp-action="Details" asp-route-id="@Model.IntegrazioneId">
                                    Richiesta Integrazione
                                </a>
                            </p>
                            @if (!string.IsNullOrEmpty(Model.IntegrazioneOggetto))
                            {
                                <p class="text-muted small mb-0">
                                    @(Model.IntegrazioneOggetto.Length > 100 
                                        ? Model.IntegrazioneOggetto.Substring(0, 100) + "..." 
                                        : Model.IntegrazioneOggetto)
                                </p>
                            }
                        </div>
                    }

                    @if (!Model.GaraId.HasValue && !Model.LottoId.HasValue && 
                         !Model.PreventivoId.HasValue && !Model.IntegrazioneId.HasValue)
                    {
                        <div class="alert alert-warning mb-0">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Documento non associato</strong>
                            <p class="mb-0 small">Questo documento non è associato ad alcuna entità.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Card Utente Caricamento -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-person me-2"></i>
                        Caricato Da
                    </h5>
                </div>
                <div class="card-body">
                    <dl class="row mb-0">
                        <dt class="col-sm-4">Utente:</dt>
                        <dd class="col-sm-8">
                            <strong>@Model.CaricatoDaNome</strong>
                        </dd>

                        @if (!string.IsNullOrEmpty(Model.CaricatoDaEmail))
                        {
                            <dt class="col-sm-4">Email:</dt>
                            <dd class="col-sm-8">
                                <a href="mailto:@Model.CaricatoDaEmail">@Model.CaricatoDaEmail</a>
                            </dd>
                        }

                        <dt class="col-sm-4">Data:</dt>
                        <dd class="col-sm-8">
                            @Model.DataCaricamento.ToString("dd/MM/yyyy HH:mm")
                        </dd>
                    </dl>
                </div>
            </div>

            <!-- Card Audit Trail -->
            <div class="card bg-light">
                <div class="card-body">
                    <h6 class="card-title text-muted">
                        <i class="bi bi-clock-history me-2"></i>
                        Informazioni di Sistema
                    </h6>
                    <dl class="row mb-0">
                        <dt class="col-sm-5">Creato il:</dt>
                        <dd class="col-sm-7">
                            <small>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</small>
                        </dd>

                        @if (Model.ModifiedAt.HasValue)
                        {
                            <dt class="col-sm-5">Modificato il:</dt>
                            <dd class="col-sm-7">
                                <small>@Model.ModifiedAt.Value.ToString("dd/MM/yyyy HH:mm")</small>
                            </dd>
                        }

                        <dt class="col-sm-5">Path MinIO:</dt>
                        <dd class="col-sm-7">
                            <small><code style="font-size: 0.7rem;">@Model.PathMinIO</code></small>
                        </dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>

    <!-- Azioni in Basso -->
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <div>
                    <a asp-action="Index" 
                       asp-route-garaId="@Model.GaraId" 
                       asp-route-lottoId="@Model.LottoId" 
                       class="btn btn-secondary">
                        <i class="bi bi-arrow-left me-1"></i>
                        Torna alla Lista
                    </a>
                </div>
                <div>
                    <a asp-action="Download" asp-route-id="@Model.Id" class="btn btn-primary">
                        <i class="bi bi-download me-1"></i>
                        Scarica
                    </a>
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning">
                        <i class="bi bi-pencil me-1"></i>
                        Modifica
                    </a>
                    <button type="button" class="btn btn-danger" id="btnDelete">
                        <i class="bi bi-trash me-1"></i>
                        Elimina
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            
            // FUNZIONE HELPER ALERT
            function showValidationAlert(message, type = 'danger') {
                // Crea alert con ID univoco per stack verticale
                const alertId = 'alert-' + Date.now();
                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show mb-2" role="alert">
                        <i class="bi bi-${type === 'danger' ? 'exclamation-triangle' : 'check-circle'}-fill me-2"></i>
                        <strong>${type === 'danger' ? 'Errore!' : type === 'warning' ? 'Attenzione!' : 'Successo!'}</strong> ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;

                $('#validationAlertContainer').append(alertHtml);

                // Scroll alla top per vedere alert
                $('html, body').animate({ scrollTop: 0 }, 300);

                // Auto-hide dopo 8 secondi
                setTimeout(function() {
                    $('#validationAlertContainer .alert').fadeOut('slow', function() {
                        $(this).remove();
                    });
                }, 6000);
            }

            // Elimina Documento
            $('#btnDelete').click(function () {
                if (!confirm('Sei sicuro di voler eliminare questo documento?\n\nIl file rimarrà su MinIO ma non sarà più accessibile dall\'applicazione.')) {
                    return;
                }

                $.ajax({
                    url: '@Url.Action("Delete", "DocumentiGara")',
                    type: 'POST',
                    data: {
                        id: '@Model.Id',
                        garaId: '@Model.GaraId',
                        lottoId: '@Model.LottoId',
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                    },
                    success: function (result) {
                        if (result.success) {
                            //toastr.success('Documento eliminato con successo');
                            window.location.href = result.redirectUrl;
                        } else {
                            // toastr.error(result.message);
                            setTimeout(function() {
                                showValidationAlert(
                                    result.message,
                                    'danger'
                                );
                            }, 300);
                        }
                    },
                    error: function () {
                        // toastr.error('Errore nell\'eliminazione del documento');
                        setTimeout(function() {
                            showValidationAlert(
                                result.message,
                                'danger'
                            );
                        }, 300);
                    }
                });
            });
        });
    </script>
}

@model Trasformazioni.Models.ViewModels.ElaborazioneLottoEditViewModel

@{
    ViewData["Title"] = "Elaborazione Lotto";
    
    // Recupera dati ViewBag
    var lottoId = ViewBag.LottoId as Guid?;
    var garaId = ViewBag.GaraId as Guid?;
    var codiceLotto = ViewBag.CodiceLotto as string ?? "";
    var descrizioneLotto = ViewBag.DescrizioneLotto as string ?? "";
    var codiceGara = ViewBag.CodiceGara as string ?? "";
    var titoloGara = ViewBag.TitoloGara as string ?? "";
    var statoLotto = ViewBag.StatoLotto;
    
    // Info economiche
    var importoBaseAsta = ViewBag.ImportoBaseAsta as decimal?;
    var quotazione = ViewBag.Quotazione as decimal?;
    var giorniFornitura = ViewBag.GiorniFornitura as int?;
    
    // Preventivi selezionati
    var preventiviSelezionati = ViewBag.PreventiviSelezionati as List<Trasformazioni.Models.ViewModels.PreventivoListViewModel> ?? new List<Trasformazioni.Models.ViewModels.PreventivoListViewModel>();
    var numeroPreventiviSelezionati = ViewBag.NumeroPreventiviSelezionati as int? ?? 0;

    // Documenti caricati
    var documentiLotto = ViewBag.DocumentiLotto as List<Trasformazioni.Models.ViewModels.DocumentoGara.DocumentoGaraListViewModel> ?? new List<Trasformazioni.Models.ViewModels.DocumentoGara.DocumentoGaraListViewModel>();
    var numeroDocumenti = ViewBag.NumeroDocumenti as int? ?? 0;

    // Statistiche
    var importoMinimo = ViewBag.ImportoMinimo as decimal?;
    var importoMassimo = ViewBag.ImportoMassimo as decimal?;
    var importoMedio = ViewBag.ImportoMedio as decimal?;
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
            <li class="breadcrumb-item"><a asp-controller="Lotti" asp-action="Index">Lotti</a></li>
            <li class="breadcrumb-item"><a asp-controller="Lotti" asp-action="Details" asp-route-id="@lottoId">@codiceLotto</a></li>
            <li class="breadcrumb-item active" aria-current="page">Elaborazione</li>
        </ol>
    </nav>

    <!-- Success/Error Messages -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="bi bi-check-circle"></i> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-12">
            <h2>
                <i class="bi bi-calculator text-primary me-2"></i>
                Elaborazione Lotto: @codiceLotto
            </h2>
            <p class="text-muted mb-0">
                Definisci i prezzi di uscita consultando i preventivi selezionati e le informazioni economiche del lotto
            </p>
        </div>
    </div>

    <form asp-action="Edit" asp-route-lottoId="@lottoId" method="post" id="formElaborazione">
        @Html.AntiForgeryToken()
        @Html.HiddenFor(m => m.Id)
        @Html.HiddenFor(m => m.LottoId)

        <div class="row">
            <!-- Colonna Sinistra: Info e Preventivi -->
            <div class="col-lg-7">
                
                <!-- Card 1: Info Lotto -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-box-seam me-2"></i>
                            Informazioni Lotto
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Codice Lotto:</dt>
                            <dd class="col-sm-8"><strong>@codiceLotto</strong></dd>

                            <dt class="col-sm-4">Descrizione:</dt>
                            <dd class="col-sm-8">@descrizioneLotto</dd>

                            <dt class="col-sm-4">Gara:</dt>
                            <dd class="col-sm-8">@codiceGara - @titoloGara</dd>

                            <dt class="col-sm-4">Stato:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-hourglass-split me-1"></i>
                                    In Elaborazione
                                </span>
                            </dd>
                        </dl>
                    </div>
                </div>

                <!-- Card 2: Info Economiche -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-currency-euro me-2"></i>
                            Informazioni Economiche
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            @if (importoBaseAsta.HasValue)
                            {
                                <dt class="col-sm-6">Importo Base d'Asta:</dt>
                                <dd class="col-sm-6">
                                    <strong class="text-primary">@importoBaseAsta.Value.ToString("C2")</strong>
                                </dd>
                            }

                            @if (quotazione.HasValue)
                            {
                                <dt class="col-sm-6">Quotazione:</dt>
                                <dd class="col-sm-6">
                                    <strong class="text-success">@quotazione.Value.ToString("C2")</strong>
                                </dd>
                            }

                            @if (giorniFornitura.HasValue)
                            {
                                <dt class="col-sm-6">Giorni Fornitura:</dt>
                                <dd class="col-sm-6">
                                    <strong>@giorniFornitura giorni</strong>
                                </dd>
                            }

                            @if (!importoBaseAsta.HasValue && !quotazione.HasValue && !giorniFornitura.HasValue)
                            {
                                <dd class="col-sm-12 text-muted">
                                    <em>Nessuna informazione economica disponibile</em>
                                </dd>
                            }
                        </dl>
                    </div>
                </div>

                <!-- Card 3: Preventivi Selezionati ⭐ -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-star-fill me-2"></i>
                            Preventivi Selezionati
                            <span class="badge bg-light text-dark ms-2">@numeroPreventiviSelezionati</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (numeroPreventiviSelezionati > 0)
                        {
                            <!-- Tabella Preventivi -->
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Fornitore</th>
                                            <th class="text-end">Importo Proposto</th>
                                            <th class="text-center">Giorni alla scadenza</th>
                                            <th class="text-center">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var preventivo in preventiviSelezionati)
                                        {
                                            <tr>
                                                <td>
                                                    <strong>@preventivo.NomeFornitore</strong>
                                                    @if (!string.IsNullOrWhiteSpace(preventivo.Descrizione))
                                                    {
                                                        <br />
                                                        <small class="text-muted">
                                                            @(preventivo.Descrizione.Length > 50 
                                                                ? preventivo.Descrizione.Substring(0, 50) + "..." 
                                                                : preventivo.Descrizione)
                                                        </small>
                                                    }
                                                </td>
                                                <td class="text-end">
                                                    @if (preventivo.ImportoOfferto.HasValue)
                                                    {
                                                        <strong class="text-primary">
                                                            @preventivo.ImportoOfferto.Value.ToString("C2")
                                                        </strong>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/D</span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    @if (preventivo.GiorniRimanenti.HasValue)
                                                    {
                                                        <span class="badge bg-info">
                                                            @preventivo.GiorniRimanenti gg
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-muted">N/D</span>
                                                    }
                                                </td>
                                                <td class="text-center">
                                                    <a asp-controller="Preventivi" 
                                                       asp-action="Details" 
                                                       asp-route-id="@preventivo.Id" 
                                                       class="btn btn-sm btn-outline-primary"
                                                       target="_blank"
                                                       title="Vedi dettaglio preventivo">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Statistiche Preventivi ⭐ -->
                            <div class="alert alert-light border mt-3 mb-0">
                                <h6 class="alert-heading">
                                    <i class="bi bi-graph-up me-2"></i>
                                    Statistiche Preventivi
                                </h6>
                                <div class="row text-center">
                                    @if (importoMinimo.HasValue)
                                    {
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Importo Minimo</small>
                                            <strong class="text-success">@importoMinimo.Value.ToString("C2")</strong>
                                        </div>
                                    }
                                    @if (importoMedio.HasValue)
                                    {
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Importo Medio</small>
                                            <strong class="text-primary">@importoMedio.Value.ToString("C2")</strong>
                                        </div>
                                    }
                                    @if (importoMassimo.HasValue)
                                    {
                                        <div class="col-md-4">
                                            <small class="text-muted d-block">Importo Massimo</small>
                                            <strong class="text-danger">@importoMassimo.Value.ToString("C2")</strong>
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <!-- Nessun preventivo selezionato -->
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Attenzione:</strong> Non ci sono preventivi selezionati per questo lotto.
                                <br />
                                Si consiglia di <a asp-controller="Preventivi" asp-action="Index" asp-route-lottoId="@lottoId">selezionare almeno un preventivo</a> 
                                prima di definire il prezzo di uscita.
                            </div>
                        }
                    </div>
                </div>

                <!-- Card 4: Documenti Caricati ⭐ -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-pdf me-2"></i>
                            Documenti Caricati
                            <span class="badge bg-light text-dark ms-2">@numeroDocumenti</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        @if (numeroDocumenti > 0)
                        {
                            <!-- Lista documenti -->
                            <div class="list-group">
                                @foreach (var doc in documentiLotto.Take(5))
                                {
                                    <div class="list-group-item d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                                            <strong>@doc.NomeFile</strong>
                                            <br />
                                            <small class="text-muted">
                                                @doc.TipoDocumentoNome.ToString()
                                                •
                                                @doc.DataCaricamento.ToString("dd/MM/yyyy HH:mm")
                                                @if (doc.DimensioneBytes > 0)
                                                {
                                                    <text> • </text>
                                                    @((doc.DimensioneBytes / 1024.0 / 1024.0).ToString("F2"))
                                                    <text> MB </text>
                                                }
                                            </small>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <a asp-controller="DocumentiGara"
                                               asp-action="Details"
                                               asp-route-id="@doc.Id"
                                               class="btn btn-sm btn-outline-primary"
                                               target="_blank"
                                               title="Anteprima">
                                                <i class="bi bi-eye"></i>
                                            </a>
                                            <a asp-controller="DocumentiGara"
                                               asp-action="Download"
                                               asp-route-id="@doc.Id"
                                               class="btn btn-sm btn-outline-success"
                                               title="Download">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </div>
                                    </div>
                                }
                            </div>

                            @if (numeroDocumenti > 5)
                            {
                                <div class="text-center mt-2">
                                    <small class="text-muted">
                                        Mostrati 5 di @numeroDocumenti documenti.
                                        <a asp-controller="DocumentiGara" asp-action="Index" asp-route-lottoId="@lottoId">
                                            Vedi tutti
                                        </a>
                                    </small>
                                </div>
                            }

                            <!-- Bottone carica altri -->
                            <div class="mt-3">
                                <a asp-controller="DocumentiGara"
                                   asp-action="Upload"
                                   asp-route-garaId="@garaId"
                                   asp-route-lottoId="@lottoId"
                                   class="btn btn-sm btn-outline-primary w-100">
                                    <i class="bi bi-plus-circle me-1"></i>
                                    Carica Altri Documenti
                                </a>
                            </div>
                        }
                        else
                        {
                            <!-- Nessun documento caricato -->
                            <div class="alert alert-warning mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Attenzione:</strong> Non ci sono documenti caricati per questo lotto.
                                <br />
                                <small class="text-muted">
                                    È obbligatorio caricare almeno un documento prima di finalizzare l'elaborazione.
                                </small>
                                <div class="mt-3">
                                    <a asp-controller="DocumentiGara"
                                       asp-action="Upload"
                                       asp-route-garaId="@garaId"
                                       asp-route-lottoId="@lottoId"
                                       class="btn btn-primary">
                                        <i class="bi bi-upload me-1"></i>
                                        Carica Documenti Ora
                                    </a>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>

            <!-- Colonna Destra: Form Prezzi -->
            <div class="col-lg-5">
                
                <!-- Card 4: Form Prezzi ⭐ -->
                <div class="card mb-3 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-cash-stack me-2"></i>
                            Calcolo Prezzi
                        </h5>
                    </div>
                    <div class="card-body">
                        
                        <!-- Suggerimento Prezzo (se ci sono preventivi) -->
                        @if (importoMedio.HasValue && numeroPreventiviSelezionati > 0)
                        {
                            <div class="alert alert-info">
                                <i class="bi bi-lightbulb-fill me-2"></i>
                                <strong>Suggerimento:</strong> 
                                Basandoti sui @numeroPreventiviSelezionati preventivi selezionati, 
                                il prezzo medio è <strong>@importoMedio.Value.ToString("C2")</strong>.
                                @if (importoBaseAsta.HasValue)
                                {
                                    var percentualeSuBase = Math.Round((importoMedio.Value / importoBaseAsta.Value) * 100, 1);
                                    <br />
                                    <small>
                                        Questo rappresenta il <strong>@percentualeSuBase%</strong> dell'importo base d'asta.
                                    </small>
                                }
                            </div>
                        }

                        <!-- Prezzo Desiderato -->
                        <div class="mb-3">
                            <label asp-for="PrezzoDesiderato" class="form-label">
                                <i class="bi bi-bullseye me-1"></i>
                                Prezzo Desiderato
                                <span class="text-muted">(opzionale)</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="PrezzoDesiderato" 
                                       class="form-control" 
                                       type="number" 
                                       step="0.01" 
                                       min="0"
                                       placeholder="Es: 50000.00" />
                            </div>
                            <small class="form-text text-muted">
                                Il prezzo che vorresti ottenere idealmente
                            </small>
                            <span asp-validation-for="PrezzoDesiderato" class="text-danger"></span>
                        </div>

                        <!-- Prezzo Reale Uscita -->
                        <div class="mb-3">
                            <label asp-for="PrezzoRealeUscita" class="form-label">
                                <i class="bi bi-check-circle me-1"></i>
                                Prezzo Reale Uscita
                                <span class="text-muted">(obbligatorio per finalizzare)</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="PrezzoRealeUscita" 
                                       class="form-control" 
                                       type="number" 
                                       step="0.01" 
                                       min="0"
                                       placeholder="Es: 52000.00" />
                            </div>
                            <small class="form-text text-muted">
                                Il prezzo finale effettivo con cui presenterai l'offerta
                            </small>
                            <span asp-validation-for="PrezzoRealeUscita" class="text-danger"></span>
                        </div>

                        <!-- Motivazione Adattamento (condizionale) -->
                        <div class="mb-3" id="motivazioneContainer">
                            <label asp-for="MotivazioneAdattamento" class="form-label">
                                <i class="bi bi-chat-left-text me-1"></i>
                                Motivazione Adattamento
                                <span class="text-danger" id="motivazioneRequired" style="display: none;">*</span>
                            </label>
                            <textarea asp-for="MotivazioneAdattamento" 
                                      class="form-control" 
                                      rows="3"
                                      maxlength="2000"
                                      placeholder="Spiega perché il prezzo reale è diverso dal prezzo desiderato..."></textarea>
                            <small class="form-text text-muted">
                                Obbligatorio se il prezzo reale è diverso dal prezzo desiderato
                            </small>
                            <span asp-validation-for="MotivazioneAdattamento" class="text-danger"></span>
                        </div>

                        <!-- Note -->
                        <div class="mb-3">
                            <label asp-for="Note" class="form-label">
                                <i class="bi bi-sticky me-1"></i>
                                Note
                            </label>
                            <textarea asp-for="Note" 
                                      class="form-control" 
                                      rows="3"
                                      maxlength="2000"
                                      placeholder="Eventuali note aggiuntive..."></textarea>
                            <span asp-validation-for="Note" class="text-danger"></span>
                        </div>

                        <!-- Riepilogo Calcoli (dinamico via JS) -->
                        <div id="calcoliRiepilogo" style="display: none;">
                            <hr />
                            <h6>
                                <i class="bi bi-calculator me-2"></i>
                                Riepilogo Calcoli
                            </h6>
                            <dl class="row small mb-0">
                                <dt class="col-sm-8">Scostamento da Preventivo Minimo:</dt>
                                <dd class="col-sm-4 text-end" id="scostamentoMinimo">-</dd>

                                <dt class="col-sm-8">Scostamento da Preventivo Medio:</dt>
                                <dd class="col-sm-4 text-end" id="scostamentoMedio">-</dd>

                                @if (importoBaseAsta.HasValue)
                                {
                                    <dt class="col-sm-8">Percentuale su Importo Base:</dt>
                                    <dd class="col-sm-4 text-end" id="percentualeBase">-</dd>
                                }
                            </dl>
                        </div>

                    </div>
                </div>

                <!-- Card 5: Azioni -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <!-- Salva Bozza -->
                            <button type="submit" name="azione" value="salva" class="btn btn-primary btn-lg">
                                <i class="bi bi-save me-2"></i>
                                Salva
                            </button>

                            <!-- Finalizza (richiede prezzi compilati) -->
                            <button type="button" id="btnFinalizza" class="btn btn-success btn-lg">
                                <i class="bi bi-check-circle me-2"></i>
                                Finalizza e Presenta
                            </button>

                            <!-- Annulla Elaborazione -->
                            <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#modalAnnulla">
                                <i class="bi bi-arrow-counterclockwise me-2"></i>
                                Annulla Elaborazione
                            </button>

                            <!-- Torna al Lotto -->
                            <a asp-controller="Lotti" asp-action="Details" asp-route-id="@lottoId" 
                               class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>
                                Torna al Lotto
                            </a>
                        </div>

                        <hr />
                        
                        <div class="alert alert-light border mb-0">
                            <small class="text-muted">
                                <i class="bi bi-info-circle me-1"></i>
                                <strong>Salva Bozza:</strong> Salva i prezzi senza cambiare lo stato del lotto.
                                <br />
                                <strong>Finalizza:</strong> Valida i dati e presenta l'offerta (stato → Presentato).
                            </small>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

<!-- Modal Annulla Elaborazione -->
<div class="modal fade" id="modalAnnulla" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Conferma Annullamento
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Sei sicuro di voler annullare l'elaborazione?</p>
                <ul>
                    <li>L'elaborazione verrà eliminata</li>
                    <li>Il lotto tornerà allo stato <strong>"Approvato"</strong></li>
                    <li>Potrai avviare una nuova elaborazione in seguito</li>
                </ul>
                <p class="text-danger mb-0">
                    <strong>Attenzione:</strong> Questa azione non può essere annullata.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, torna indietro</button>
                <form asp-action="Annulla" asp-route-lottoId="@lottoId" method="post" style="display: inline;">
                    @Html.AntiForgeryToken()
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-trash me-2"></i>
                        Sì, annulla elaborazione
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function () {
            
            // Dati per calcoli (da ViewBag)
            const importoMinimo = @(importoMinimo?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "null");
            const importoMedio = @(importoMedio?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "null");
            const importoBaseAsta = @(importoBaseAsta?.ToString("F2", System.Globalization.CultureInfo.InvariantCulture) ?? "null");

            // ==========================================
            // VALIDAZIONE MOTIVAZIONE CONDIZIONALE
            // ==========================================
            function validaMotivazioneAdattamento() {
                const prezzoDesiderato = parseFloat($('#PrezzoDesiderato').val()) || 0;
                const prezzoReale = parseFloat($('#PrezzoRealeUscita').val()) || 0;
                
                const motivazioneTextarea = $('#MotivazioneAdattamento');
                const motivazioneRequired = $('#motivazioneRequired');
                
                // Se prezzi diversi → motivazione obbligatoria
                if (prezzoDesiderato > 0 && prezzoReale > 0 && prezzoDesiderato !== prezzoReale) {
                    motivazioneTextarea.attr('required', 'required');
                    motivazioneRequired.show();
                    $('#motivazioneContainer').addClass('border border-warning p-2 rounded');
                } else {
                    motivazioneTextarea.removeAttr('required');
                    motivazioneRequired.hide();
                    $('#motivazioneContainer').removeClass('border border-warning p-2 rounded');
                }
            }

            // ==========================================
            // CALCOLI RIEPILOGO DINAMICI
            // ==========================================
            function aggiornaCalcoli() {
                const prezzoReale = parseFloat($('#PrezzoRealeUscita').val());
                
                if (!prezzoReale || prezzoReale <= 0) {
                    $('#calcoliRiepilogo').hide();
                    return;
                }

                $('#calcoliRiepilogo').show();

                // Scostamento da minimo
                if (importoMinimo !== null) {
                    const scostamento = ((prezzoReale - importoMinimo) / importoMinimo * 100).toFixed(2);
                    const colore = scostamento > 0 ? 'text-danger' : 'text-success';
                    $('#scostamentoMinimo').html(`<span class="${colore}">${scostamento > 0 ? '+' : ''}${scostamento}%</span>`);
                }

                // Scostamento da medio
                if (importoMedio !== null) {
                    const scostamento = ((prezzoReale - importoMedio) / importoMedio * 100).toFixed(2);
                    const colore = scostamento > 0 ? 'text-danger' : 'text-success';
                    $('#scostamentoMedio').html(`<span class="${colore}">${scostamento > 0 ? '+' : ''}${scostamento}%</span>`);
                }

                // Percentuale su base asta
                if (importoBaseAsta !== null) {
                    const percentuale = (prezzoReale / importoBaseAsta * 100).toFixed(1);
                    $('#percentualeBase').html(`<strong>${percentuale}%</strong>`);
                }
            }

            // Eventi su change
            $('#PrezzoDesiderato, #PrezzoRealeUscita').on('input change', function() {
                validaMotivazioneAdattamento();
                aggiornaCalcoli();
            });

            // Validazione iniziale
            validaMotivazioneAdattamento();
            aggiornaCalcoli();

            // ==========================================
            // BOTTONE FINALIZZA
            // ==========================================
            $('#btnFinalizza').on('click', function() {
                // Valida form: Prezzo Reale obbligatorio per finalizzare
                const prezzoReale = parseFloat($('#PrezzoRealeUscita').val());

                if (!prezzoReale || prezzoReale <= 0) {
                    alert('Attenzione: Il prezzo reale è obbligatorio per finalizzare l\'elaborazione.\n\nCompila il campo "Prezzo Reale Uscita" prima di procedere.');
                    $('#PrezzoRealeUscita').focus().addClass('is-invalid');
                    return;
                }

                // Rimuovi classe errore se presente
                $('#PrezzoRealeUscita').removeClass('is-invalid');

                // Conferma finale
                if (confirm('Sei sicuro di voler finalizzare l\'elaborazione?\n\nIl lotto passerà allo stato "Presentato" e l\'offerta sarà considerata pronta per la presentazione.')) {
                    // Submit form con action finalizza
                    const form = $('#formElaborazione');
                    form.attr('action', '@Url.Action("Finalizza", "Elaborazione", new { lottoId })');
                    form.submit();
                }
            });

        });
    </script>
}

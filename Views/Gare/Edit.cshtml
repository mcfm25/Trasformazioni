@model Trasformazioni.Models.ViewModels.GaraEditViewModel
@{
    ViewData["Title"] = "Modifica Gara";
}

<div class="container-fluid py-4">

    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item"><a asp-action="Index">Gare</a></li>
                    <li class="breadcrumb-item"><a asp-action="Details" asp-route-id="@Model.Id">@Model.CodiceGara</a></li>
                    <li class="breadcrumb-item active">Modifica</li>
                </ol>
            </nav>
            <h1 class="h3 fw-bold mb-1">
                <i class="bi bi-pencil-square text-warning me-2"></i>
                Modifica Gara: @Model.CodiceGara
            </h1>
            <p class="text-muted mb-0">Aggiorna le informazioni della gara</p>
        </div>
        <div class="col-auto">
            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle me-1"></i>
                Annulla
            </a>
        </div>
    </div>

    <!-- Form -->
    <form asp-action="Edit" method="post" id="editForm">
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

        <!-- Hidden Fields -->
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="NumeroLotti" />
        <input type="hidden" asp-for="CreatedAt" />
        <input type="hidden" asp-for="CreatedBy" />
        <input type="hidden" asp-for="ModifiedAt" />
        <input type="hidden" asp-for="ModifiedBy" />

        <div class="row">
            <!-- Colonna Principale -->
            <div class="col-lg-8">

                <!-- Card Identificazione -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Informazioni Principali
                            <span class="badge bg-danger ms-2">Obbligatorie</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Codice Gara -->
                            <div class="col-md-4">
                                <label asp-for="CodiceGara" class="form-label fw-bold">
                                    <span class="text-danger">*</span> Codice Gara
                                </label>
                                <input asp-for="CodiceGara" 
                                       class="form-control" 
                                       data-val-remote-url="/Gare/CheckCodiceGara?excludeId=@Model.Id"
                                       data-val-remote="Questo codice gara è già utilizzato"
                                       />
                                <span asp-validation-for="CodiceGara" class="text-danger"></span>
                            </div>

                            <!-- Tipologia -->
                            <div class="col-md-4">
                                <label asp-for="Tipologia" class="form-label fw-bold">
                                    <span class="text-danger">*</span> Tipologia
                                </label>
                                <select asp-for="Tipologia" 
                                        class="form-select" 
                                        asp-items="ViewBag.TipologieGara">
                                </select>
                                <span asp-validation-for="Tipologia" class="text-danger"></span>
                            </div>

                            <!-- Stato -->
                            <div class="col-md-4">
                                <label asp-for="Stato" class="form-label fw-bold">
                                    <span class="text-danger">*</span> Stato
                                </label>
                                <select asp-for="Stato" 
                                        class="form-select" 
                                        asp-items="ViewBag.StatiGara">
                                </select>
                                <span asp-validation-for="Stato" class="text-danger"></span>
                                <small class="text-muted">Modifica lo stato manualmente se necessario</small>
                            </div>

                            <!-- Titolo -->
                            <div class="col-12">
                                <label asp-for="Titolo" class="form-label fw-bold">
                                    <span class="text-danger">*</span> Titolo
                                </label>
                                <input asp-for="Titolo" class="form-control" />
                                <span asp-validation-for="Titolo" class="text-danger"></span>
                            </div>

                            <!-- PNRR -->
                            <div class="col-12">
                                <div class="form-check">
                                    <input asp-for="PNRR" class="form-check-input" type="checkbox" />
                                    <label asp-for="PNRR" class="form-check-label">
                                        PNRR
                                    </label>
                                </div>
                            </div>

                            <!-- Descrizione -->
                            <div class="col-12">
                                <label asp-for="Descrizione" class="form-label">Descrizione</label>
                                <textarea asp-for="Descrizione" 
                                          class="form-control" 
                                          rows="4"></textarea>
                                <span asp-validation-for="Descrizione" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Ente Appaltante -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>
                            Ente Appaltante
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label asp-for="EnteAppaltante" class="form-label">Denominazione Ente</label>
                                <input asp-for="EnteAppaltante" class="form-control" />
                                <span asp-validation-for="EnteAppaltante" class="text-danger"></span>
                            </div>

                            <div class="col-md-4">
                                <label asp-for="Regione" class="form-label">Regione</label>
                                <input asp-for="Regione" class="form-control" list="regioniList" />
                                <datalist id="regioniList">
                                    <option value="Abruzzo" />
                                    <option value="Basilicata" />
                                    <option value="Calabria" />
                                    <option value="Campania" />
                                    <option value="Emilia-Romagna" />
                                    <option value="Friuli-Venezia Giulia" />
                                    <option value="Lazio" />
                                    <option value="Liguria" />
                                    <option value="Lombardia" />
                                    <option value="Marche" />
                                    <option value="Molise" />
                                    <option value="Piemonte" />
                                    <option value="Puglia" />
                                    <option value="Sardegna" />
                                    <option value="Sicilia" />
                                    <option value="Toscana" />
                                    <option value="Trentino-Alto Adige" />
                                    <option value="Umbria" />
                                    <option value="Valle d'Aosta" />
                                    <option value="Veneto" />
                                </datalist>
                                <span asp-validation-for="Regione" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="NomePuntoOrdinante" class="form-label">Punto Ordinante</label>
                                <input asp-for="NomePuntoOrdinante" class="form-control" />
                                <span asp-validation-for="NomePuntoOrdinante" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="TelefonoPuntoOrdinante" class="form-label">Telefono</label>
                                <input asp-for="TelefonoPuntoOrdinante" class="form-control" type="tel" />
                                <span asp-validation-for="TelefonoPuntoOrdinante" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Codici -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-upc-scan me-2"></i>
                            Codici e Riferimenti
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label asp-for="CIG" class="form-label">CIG</label>
                                <input asp-for="CIG" class="form-control" />
                                <span asp-validation-for="CIG" class="text-danger"></span>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="CUP" class="form-label">CUP</label>
                                <input asp-for="CUP" class="form-control" />
                                <span asp-validation-for="CUP" class="text-danger"></span>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="RDO" class="form-label">RDO</label>
                                <input asp-for="RDO" class="form-control" />
                                <span asp-validation-for="RDO" class="text-danger"></span>
                            </div>

                            <div class="col-md-3">
                                <label asp-for="Bando" class="form-label">Bando</label>
                                <input asp-for="Bando" class="form-control" />
                                <span asp-validation-for="Bando" class="text-danger"></span>
                            </div>

                            <div class="col-12">
                                <label asp-for="DenominazioneIniziativa" class="form-label">Denominazione Iniziativa</label>
                                <input asp-for="DenominazioneIniziativa" class="form-control" />
                                <span asp-validation-for="DenominazioneIniziativa" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="Procedura" class="form-label">Procedura</label>
                                <input asp-for="Procedura" class="form-control" />
                                <span asp-validation-for="Procedura" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="CriterioAggiudicazione" class="form-label">Criterio Aggiudicazione</label>
                                <input asp-for="CriterioAggiudicazione" class="form-control" />
                                <span asp-validation-for="CriterioAggiudicazione" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Date -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-event me-2"></i>
                            Date Importanti
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label asp-for="DataPubblicazione" class="form-label">Data Pubblicazione</label>
                                <input asp-for="DataPubblicazione" class="form-control" type="date" />
                                <span asp-validation-for="DataPubblicazione" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="DataInizioPresentazioneOfferte" class="form-label">
                                    Inizio Presentazione Offerte
                                </label>
                                <input asp-for="DataInizioPresentazioneOfferte" class="form-control" type="datetime-local" />
                                <span asp-validation-for="DataInizioPresentazioneOfferte" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="DataTermineRichiestaChiarimenti" class="form-label">
                                    Termine Richiesta Chiarimenti
                                </label>
                                <input asp-for="DataTermineRichiestaChiarimenti" class="form-control" type="datetime-local" />
                                <span asp-validation-for="DataTermineRichiestaChiarimenti" class="text-danger"></span>
                            </div>

                            <div class="col-md-6">
                                <label asp-for="DataTerminePresentazioneOfferte" class="form-label">
                                    <i class="bi bi-exclamation-circle text-warning"></i>
                                    Termine Presentazione Offerte
                                </label>
                                <input asp-for="DataTerminePresentazioneOfferte" class="form-control" type="datetime-local" />
                                <span asp-validation-for="DataTerminePresentazioneOfferte" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Chiusura Manuale (solo se IsChiusaManualmente) -->
                @if (Model.IsChiusaManualmente)
                {
                    <div class="card shadow-sm border-warning mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="bi bi-lock-fill me-2"></i>
                                Chiusura Manuale
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning mb-3">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>Attenzione:</strong> Questa gara è stata chiusa manualmente.
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="DataChiusuraManuale" class="form-label">Data Chiusura</label>
                                    <input asp-for="DataChiusuraManuale" class="form-control" type="date" />
                                    <span asp-validation-for="DataChiusuraManuale" class="text-danger"></span>
                                </div>

                                <div class="col-12">
                                    <label asp-for="MotivoChiusuraManuale" class="form-label">Motivo Chiusura</label>
                                    <textarea asp-for="MotivoChiusuraManuale" 
                                              class="form-control" 
                                              rows="3"
                                              placeholder="Specificare il motivo della chiusura manuale"></textarea>
                                    <span asp-validation-for="MotivoChiusuraManuale" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                }

                <!-- Card Checklist Documenti Richiesti -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-list-check me-2"></i>
                            Checklist Documenti Richiesti
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">
                            <i class="bi bi-info-circle"></i>
                            Seleziona i tipi di documento che dovranno essere caricati per questa gara.
                        </p>

                        @if (ViewBag.TipiDocumentoChecklist != null)
                        {
                            <div class="row">
                                @foreach (var tipo in (List<SelectListItem>)ViewBag.TipiDocumentoChecklist)
                                {
                                    <div class="col-md-6 mb-2">
                                        <div class="form-check">
                                            <input class="form-check-input"
                                                   type="checkbox"
                                                   name="DocumentiRichiestiIds"
                                                   value="@tipo.Value"
                                                   id="docRichiesto_@tipo.Value"
                                                   @(tipo.Selected ? "checked" : "") />
                                            <label class="form-check-label" for="docRichiesto_@tipo.Value">
                                                @tipo.Text
                                            </label>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-secondary mb-0">
                                <i class="bi bi-exclamation-circle"></i>
                                Nessun tipo documento disponibile per l'area Gare.
                            </div>
                        }
                    </div>
                </div>

            </div>

            <!-- Colonna Laterale -->
            <div class="col-lg-4">

                <!-- Card Azioni -->
                <div class="card shadow-sm border-0 mb-4 sticky-top">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-save me-2"></i>
                            Salva Modifiche
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-warning btn-lg">
                                <i class="bi bi-check-circle me-2"></i>
                                Salva Modifiche
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-1"></i>
                                Annulla
                            </a>
                        </div>

                        <hr />

                        <div class="alert alert-info mb-0 small">
                            <i class="bi bi-info-circle me-1"></i>
                            <strong>Info:</strong>
                            <ul class="mb-0 mt-2 ps-3">
                                <li>Le modifiche saranno salvate immediatamente</li>
                                <li>I campi obbligatori sono contrassegnati con <span class="text-danger">*</span></li>
                                @if (Model.NumeroLotti > 0)
                                {
                                    <li class="text-warning"><strong>Attenzione:</strong> Questa gara ha @Model.NumeroLotti lotti associati</li>
                                }
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Card Info Economiche -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-currency-euro me-2"></i>
                            Informazioni Economiche
                        </h6>
                    </div>
                    <div class="card-body">
                        <label asp-for="ImportoTotaleStimato" class="form-label">Importo Totale Stimato</label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input asp-for="ImportoTotaleStimato" 
                                   class="form-control" 
                                   type="number" 
                                   step="0.01"
                                   min="0" />
                        </div>
                        <span asp-validation-for="ImportoTotaleStimato" class="text-danger"></span>
                    </div>
                </div>

                <!-- Card Link -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">
                            <i class="bi bi-link-45deg me-2"></i>
                            Link Piattaforma
                        </h6>
                    </div>
                    <div class="card-body">
                        <label asp-for="LinkPiattaforma" class="form-label">URL Piattaforma</label>
                        <input asp-for="LinkPiattaforma" class="form-control" type="url" />
                        <span asp-validation-for="LinkPiattaforma" class="text-danger"></span>
                    </div>
                </div>

                <!-- Card Info Sistema (Read Only) -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-light">
                        <h6 class="mb-0 text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            Informazioni Sistema
                        </h6>
                    </div>
                    <div class="card-body small text-muted">
                        <div class="mb-2">
                            <strong>Creata il:</strong>
                            <div>@Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")</div>
                            @if (!string.IsNullOrWhiteSpace(Model.CreatedBy))
                            {
                                <div>da @Model.CreatedBy</div>
                            }
                        </div>
                        @if (Model.ModifiedAt.HasValue)
                        {
                            <div>
                                <strong>Ultima modifica:</strong>
                                <div>@Model.ModifiedAt.Value.ToString("dd/MM/yyyy HH:mm")</div>
                                @if (!string.IsNullOrWhiteSpace(Model.ModifiedBy))
                                {
                                    <div>da @Model.ModifiedBy</div>
                                }
                            </div>
                        }
                        @if (Model.NumeroLotti > 0)
                        {
                            <hr />
                            <div>
                                <strong>Lotti associati:</strong>
                                <div class="badge bg-primary">@Model.NumeroLotti</div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        </div>
    </form>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    
    <script>
        // Validazione remote per codice gara (esclude ID corrente)
        $.validator.addMethod("remote", function (value, element, param) {
            if (!value) return true;
            
            var data = {};
            data[element.name] = value;
            
            var result = "pending";
            $.ajax({
                url: param.url,
                type: "GET",
                data: data,
                async: false,
                success: function (response) {
                    result = response === true || response === "true";
                }
            });
            return result;
        }, "");

        // Conferma prima di lasciare con modifiche non salvate
        let formChanged = false;
        $('#editForm input, #editForm select, #editForm textarea').on('change', function() {
            formChanged = true;
        });

        $(window).on('beforeunload', function() {
            if (formChanged) {
                return 'Hai modifiche non salvate. Sei sicuro di voler uscire?';
            }
        });

        $('#editForm').on('submit', function() {
            formChanged = false;
        });
    </script>
}

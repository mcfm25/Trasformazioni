@using Trasformazioni.Helpers
@using Trasformazioni.Models.Entities
@using Trasformazioni.Models.Enums
@using Trasformazioni.Models.ViewModels
@model LottoEditViewModel

@{
    ViewData["Title"] = $"Modifica Lotto: {Model.CodiceLotto}";
    var garaSelezionata = ViewBag.GaraSelezionata as GaraDetailsViewModel;// Gara;
    var isStatoTerminale = (bool)(ViewBag.IsStatoTerminale ?? false);
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <a asp-controller="Home" asp-action="Index">
                <i class="bi bi-house-door"></i> Home
            </a>
        </li>
        <li class="breadcrumb-item">
            <a asp-controller="Gare" asp-action="Index">Gare</a>
        </li>
        @if (garaSelezionata != null)
        {
            <li class="breadcrumb-item">
                <a asp-controller="Gare" asp-action="Details" asp-route-id="@garaSelezionata.Id">
                    @garaSelezionata.CodiceGara
                </a>
            </li>
        }
        <li class="breadcrumb-item">
            <a asp-action="Index">Lotti</a>
        </li>
        <li class="breadcrumb-item">
            <a asp-action="Details" asp-route-id="@Model.Id">@Model.CodiceLotto</a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">Modifica</li>
    </ol>
</nav>

<!-- Header -->
<div class="mb-4">
    <h1 class="h3">
        <i class="bi bi-pencil"></i> Modifica Lotto: <strong>@Model.CodiceLotto</strong>
    </h1>
    @if (isStatoTerminale)
    {
        <div class="alert alert-warning mt-2">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>Attenzione:</strong> Il lotto è in stato terminale (@EnumHelper.GetDisplayName(Model.Stato)).
            Alcune modifiche potrebbero non essere appropriate.
        </div>
    }
</div>

<form asp-action="Edit" method="post" id="editLottoForm">
    <input type="hidden" asp-for="Id" />
    <input type="hidden" asp-for="GaraId" />
    <input type="hidden" asp-for="CreatedAt" />
    <input type="hidden" asp-for="CreatedBy" />
    <input type="hidden" asp-for="ModifiedAt" />
    <input type="hidden" asp-for="ModifiedBy" />

    <div class="row">
        <!-- Colonna Form (8 col) -->
        <div class="col-lg-8">

            <!-- Card Gara Associata (readonly) -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-link-45deg"></i> Gara Associata
                    </h5>
                </div>
                <div class="card-body">
                    @if (garaSelezionata != null)
                    {
                        <div class="alert alert-info mb-0">
                            <i class="bi bi-info-circle"></i>
                            <strong>Gara:</strong><br>
                            <span class="fs-5">@garaSelezionata.CodiceGara - @garaSelezionata.Titolo</span>
                            <br><small class="text-muted">La gara associata non può essere modificata.</small>
                        </div>
                    }
                </div>
            </div>

            <!-- Card Dati Lotto -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-file-text"></i> Informazioni Lotto
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Codice Lotto -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="CodiceLotto" class="form-label">
                                Codice Lotto <span class="text-danger">*</span>
                            </label>
                            <input asp-for="CodiceLotto" class="form-control" />
                            <span asp-validation-for="CodiceLotto" class="text-danger"></span>
                        </div>

                        <!-- Stato -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Stato" class="form-label">
                                Stato <span class="text-danger">*</span>
                            </label>
                            <select asp-for="Stato" class="form-select" asp-items="ViewBag.Stati"></select>
                            <span asp-validation-for="Stato" class="text-danger"></span>
                            <small class="form-text text-muted">
                                ⚠️ Attenzione: modifica lo stato solo se necessario. Usa il workflow per cambi stato standard.
                            </small>
                        </div>

                        <!-- Tipologia -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Tipologia" class="form-label">
                                Tipologia <span class="text-danger">*</span>
                            </label>
                            <select asp-for="Tipologia" class="form-select" asp-items="ViewBag.Tipologie"></select>
                            <span asp-validation-for="Tipologia" class="text-danger"></span>
                        </div>

                        <!-- Descrizione -->
                        <div class="col-md-12 mb-3">
                            <label asp-for="Descrizione" class="form-label">
                                Descrizione <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="Descrizione" class="form-control" rows="4"></textarea>
                            <span asp-validation-for="Descrizione" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Dati Economici -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-currency-euro"></i> Dati Economici
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Importo Base Asta -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="ImportoBaseAsta" class="form-label">
                                Importo Base Asta (€) <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="ImportoBaseAsta" type="number" step="0.01" min="0"
                                       class="form-control" />
                            </div>
                            <span asp-validation-for="ImportoBaseAsta" class="text-danger"></span>
                        </div>

                        <!-- Quotazione -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Quotazione" class="form-label">
                                Quotazione (€)
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input asp-for="Quotazione" type="number" step="0.01" min="0"
                                       class="form-control" />
                            </div>
                            <span asp-validation-for="Quotazione" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Quotazione stimata o offerta per il lotto.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Info Contratto -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-text"></i> Informazioni Contratto
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Durata Contratto -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="DurataContratto" class="form-label">Durata Contratto</label>
                            <input asp-for="DurataContratto" class="form-control"
                                   placeholder="Es: 12 mesi, 2 anni" />
                            <span asp-validation-for="DurataContratto" class="text-danger"></span>
                        </div>

                        <!-- Fatturazione -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="Fatturazione" class="form-label">Fatturazione</label>
                            <input asp-for="Fatturazione" class="form-control"
                                   placeholder="Es: Mensile, Trimestrale" />
                            <span asp-validation-for="Fatturazione" class="text-danger"></span>
                        </div>

                        <!-- Data Stipula Contratto -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="DataStipulaContratto" class="form-label">Data Stipula Contratto</label>
                            <input asp-for="DataStipulaContratto" type="date" class="form-control" />
                            <span asp-validation-for="DataStipulaContratto" class="text-danger"></span>
                        </div>

                        <!-- Data Scadenza Contratto -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="DataScadenzaContratto" class="form-label">Data Scadenza Contratto</label>
                            <input asp-for="DataScadenzaContratto" type="date" class="form-control" />
                            <span asp-validation-for="DataScadenzaContratto" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Info Aggiuntive -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Informazioni Aggiuntive
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Link Piattaforma -->
                        <div class="col-md-12 mb-3">
                            <label asp-for="LinkPiattaforma" class="form-label">Link Piattaforma</label>
                            <input asp-for="LinkPiattaforma" class="form-control" />
                            <span asp-validation-for="LinkPiattaforma" class="text-danger"></span>
                        </div>

                        <!-- Giorni Fornitura -->
                        <div class="col-md-6 mb-3">
                            <label asp-for="GiorniFornitura" class="form-label">Giorni Fornitura</label>
                            <input asp-for="GiorniFornitura" type="number" min="1" class="form-control" />
                            <span asp-validation-for="GiorniFornitura" class="text-danger"></span>
                        </div>

                        <!-- Richiede Fideiussione -->
                        <div class="col-md-6 mb-3">
                            <div class="form-check mt-4">
                                <input asp-for="RichiedeFideiussione" class="form-check-input" type="checkbox" />
                                <label asp-for="RichiedeFideiussione" class="form-check-label">
                                    Richiede Fideiussione
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card Motivo Rifiuto (se stato Rifiutato) -->
            @if (Model.Stato == StatoLotto.Rifiutato)
            {
                <div class="card mb-4 border-danger">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-x-circle"></i> Motivo Rifiuto
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label asp-for="MotivoRifiuto" class="form-label">
                                Motivo Rifiuto <span class="text-danger">*</span>
                            </label>
                            <textarea asp-for="MotivoRifiuto" class="form-control" rows="4"
                                      placeholder="Specificare il motivo del rifiuto..."></textarea>
                            <span asp-validation-for="MotivoRifiuto" class="text-danger"></span>
                            <small class="form-text text-muted">
                                Obbligatorio quando lo stato è "Rifiutato".
                            </small>
                        </div>
                    </div>
                </div>
            }

            <!-- Card Checklist Documenti Richiesti -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-list-check"></i> Checklist Documenti Richiesti
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-3">
                        <i class="bi bi-info-circle"></i>
                        Seleziona i tipi di documento che dovranno essere caricati per questo lotto
                        prima del passaggio allo stato "Presentato".
                    </p>

                    @if (ViewBag.TipiDocumentoChecklist != null)
                    {
                        <div class="row">
                            @foreach (var tipo in (List<SelectListItem>)ViewBag.TipiDocumentoChecklist)
                            {
                                <div class="col-md-6 mb-2">
                                    <div class="form-check">
                                        <input class="form-check-input"
                                               type="checkbox"
                                               name="DocumentiRichiestiIds"
                                               value="@tipo.Value"
                                               id="docRichiesto_@tipo.Value"
                                               @(tipo.Selected ? "checked" : "") />
                                        <label class="form-check-label" for="docRichiesto_@tipo.Value">
                                            @tipo.Text
                                        </label>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-secondary mb-0">
                            <i class="bi bi-exclamation-circle"></i>
                            Nessun tipo documento disponibile.
                        </div>
                    }
                </div>
            </div>

        </div>

        <!-- Sidebar Destra (4 col) -->
        <div class="col-lg-4">

            <!-- Card Azioni -->
            <div class="card mb-3 sticky-top">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-check-circle"></i> Azioni
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Salva Modifiche
                        </button>
                        <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle"></i> Annulla
                        </a>
                    </div>
                </div>
            </div>

            <!-- Card Info Stato -->
            @if (isStatoTerminale)
            {
                <div class="card mb-3 border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Stato Terminale
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0 small">
                            Il lotto è in stato <strong>@EnumHelper.GetDisplayName(Model.Stato)</strong>.
                            Gli stati terminali indicano che il lotto ha completato il suo ciclo di vita.
                        </p>
                    </div>
                </div>
            }

            <!-- Card Info Sistema -->
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history"></i> Info Sistema
                    </h6>
                </div>
                <div class="card-body">
                    <p class="mb-2 small">
                        <strong>Creato il:</strong><br>
                        @Model.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                    </p>
                    @if (!string.IsNullOrWhiteSpace(Model.CreatedBy))
                    {
                        <p class="mb-2 small">
                            <strong>Creato da:</strong> @Model.CreatedBy
                        </p>
                    }
                    @if (Model.ModifiedAt.HasValue)
                    {
                        <p class="mb-2 small">
                            <strong>Ultima modifica:</strong><br>
                            @Model.ModifiedAt.Value.ToString("dd/MM/yyyy HH:mm")
                        </p>
                    }
                    @if (!string.IsNullOrWhiteSpace(Model.ModifiedBy))
                    {
                        <p class="mb-0 small">
                            <strong>Modificato da:</strong> @Model.ModifiedBy
                        </p>
                    }
                </div>
            </div>

            <!-- Card Campi Obbligatori -->
            <div class="card">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-asterisk text-danger"></i> Campi Obbligatori
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0 small">
                        <li><i class="bi bi-check"></i> Codice Lotto</li>
                        <li><i class="bi bi-check"></i> Descrizione</li>
                        <li><i class="bi bi-check"></i> Tipologia</li>
                        <li><i class="bi bi-check"></i> Stato</li>
                        <li><i class="bi bi-check"></i> Importo Base Asta</li>
                        @if (Model.Stato == StatoLotto.Rifiutato)
                        {
                            <li><i class="bi bi-check text-danger"></i> Motivo Rifiuto</li>
                        }
                    </ul>
                </div>
            </div>

        </div>
    </div>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // Warning before unload
            var formChanged = false;
            $("#editLottoForm input, #editLottoForm textarea, #editLottoForm select").on("change", function() {
                formChanged = true;
            });

            $(window).on("beforeunload", function() {
                if (formChanged) {
                    return "Hai modifiche non salvate. Sei sicuro di voler uscire?";
                }
            });

            // Rimuovi warning al submit
            $("#editLottoForm").on("submit", function() {
                formChanged = false;
            });

            // Warning se si modifica stato manualmente
            $("#Stato").on("change", function() {
                if (!confirm("Stai modificando manualmente lo stato del lotto.\n\nÈ consigliato usare il workflow dalla pagina Dettagli.\n\nContinuare comunque?")) {
                    $(this).val($(this).data("original-value"));
                }
            });

            // Salva valore originale stato
            $("#Stato").data("original-value", $("#Stato").val());

            // Validazione data scadenza >= data stipula
            $("#DataStipulaContratto, #DataScadenzaContratto").on("change", function() {
                var dataStipula = new Date($("#DataStipulaContratto").val());
                var dataScadenza = new Date($("#DataScadenzaContratto").val());

                if (dataStipula && dataScadenza && dataScadenza < dataStipula) {
                    alert("La data di scadenza deve essere successiva alla data di stipula.");
                    $("#DataScadenzaContratto").val("");
                }
            });
        });
    </script>
}

@using Trasformazioni.Models.ViewModels;
@model IEnumerable<ScadenzaListViewModel>

@{
    var lottoId = ViewBag.LottoId as Guid?;
    var scadenze = Model?.ToList() ?? new List<ScadenzaListViewModel>();
    var oggi = DateTime.Today;
}

<!-- Header con azioni -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h6 class="mb-0">
        <i class="bi bi-calendar-event text-primary"></i> 
        Scadenze del Lotto
        @if (scadenze.Any())
        {
            <span class="badge bg-secondary ms-2">@scadenze.Count</span>
        }
    </h6>
    <div>
        <a asp-controller="Scadenze" asp-action="Create" asp-route-lottoId="@lottoId" 
           class="btn btn-sm btn-primary">
            <i class="bi bi-plus-circle"></i> Nuova Scadenza
        </a>
        <a asp-controller="Scadenze" asp-action="Index" 
           class="btn btn-sm btn-outline-secondary ms-1">
            <i class="bi bi-calendar3"></i> Vai allo Scadenzario
        </a>
    </div>
</div>

@if (scadenze.Any())
{
    <!-- Statistiche rapide -->    
    var scadute = scadenze.Count(s => !s.IsCompletata && s.DataScadenza < oggi);
    var oggiCount = scadenze.Count(s => !s.IsCompletata && s.DataScadenza.Date == oggi);
    var inScadenza = scadenze.Count(s => !s.IsCompletata && s.DataScadenza > oggi && (s.DataScadenza - oggi).Days <= s.GiorniPreavviso);
    var attive = scadenze.Count(s => !s.IsCompletata && s.DataScadenza > oggi && (s.DataScadenza - oggi).Days > s.GiorniPreavviso);
    var completate = scadenze.Count(s => s.IsCompletata);
        
    @if (scadute > 0 || oggiCount > 0)
    {
        <div class="alert @(scadute > 0 ? "alert-danger" : "alert-warning") py-2 mb-3">
            <div class="d-flex align-items-center">
                <i class="bi @(scadute > 0 ? "bi-exclamation-triangle-fill" : "bi-exclamation-circle-fill") me-2"></i>
                <span>
                    @if (scadute > 0)
                    {
                        <strong>@scadute scadenz@(scadute == 1 ? "a" : "e") scadut@(scadute == 1 ? "a" : "e")!</strong>
                    }
                    @if (oggiCount > 0)
                    {
                        if (scadute > 0) { <text> - </text> }
                        <strong>@oggiCount scadenz@(oggiCount == 1 ? "a" : "e") in scadenza oggi!</strong>
                    }
                </span>
            </div>
        </div>
    }

    <div class="row text-center mb-3">
        <div class="col">
            <span class="badge bg-danger">@scadute Scadute</span>
        </div>
        <div class="col">
            <span class="badge bg-warning text-dark">@(oggiCount + inScadenza) Imminenti</span>
        </div>
        <div class="col">
            <span class="badge bg-primary">@attive Attive</span>
        </div>
        <div class="col">
            <span class="badge bg-success">@completate Completate</span>
        </div>
    </div>

    <!-- Tabella scadenze -->
    <div class="table-responsive">
        <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th style="width: 120px;">Data</th>
                    <th style="width: 140px;">Tipo</th>
                    <th>Descrizione</th>
                    <th style="width: 110px;">Stato</th>
                    <th style="width: 100px;" class="text-center">Azioni</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var s in scadenze.OrderBy(x => x.IsCompletata).ThenBy(x => x.DataScadenza))
                {
                    var dataScadenza = s.DataScadenza.Date;
                    var giorniRimanenti = (dataScadenza - oggi).Days;
                    
                    // Determina classe riga
                    var rowClass = "";
                    if (s.IsCompletata)
                    {
                        rowClass = "table-success opacity-75";
                    }
                    else if (dataScadenza < oggi)
                    {
                        rowClass = "table-danger";
                    }
                    else if (dataScadenza == oggi)
                    {
                        rowClass = "table-warning";
                    }
                    else if (giorniRimanenti <= s.GiorniPreavviso)
                    {
                        rowClass = "table-warning";
                    }
                    
                    <tr class="@rowClass">
                        <td>
                            <strong>@s.DataScadenza.ToString("dd/MM/yyyy")</strong>
                            @if (!s.IsCompletata)
                            {
                                if (dataScadenza < oggi)
                                {
                                    <br /><small class="text-danger">@Math.Abs(giorniRimanenti) gg fa</small>
                                }
                                else if (dataScadenza == oggi)
                                {
                                    <br /><small class="text-warning fw-bold">OGGI</small>
                                }
                                else
                                {
                                    <br /><small class="text-muted">tra @giorniRimanenti gg</small>
                                }
                            }
                        </td>
                        <td>
                            <span class="badge bg-secondary">@s.Tipo</span>
                            @if (s.IsAutomatica)
                            {
                                <br /><small class="text-info"><i class="bi bi-robot"></i> Auto</small>
                            }
                        </td>
                        <td>
                            @s.Descrizione
                           @*  @if (!string.IsNullOrEmpty(s.Note))
                            {
                                <i class="bi bi-chat-left-text text-muted ms-1" 
                                   data-bs-toggle="tooltip" 
                                   title="@s.Note"></i>
                            } *@
                        </td>
                        <td>
                            @if (s.IsCompletata)
                            {
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle-fill"></i> Completata
                                </span>
                            }
                            else if (dataScadenza < oggi)
                            {
                                <span class="badge bg-danger">
                                    <i class="bi bi-exclamation-triangle-fill"></i> Scaduta
                                </span>
                            }
                            else if (dataScadenza == oggi)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-circle-fill"></i> Oggi
                                </span>
                            }
                            else if (giorniRimanenti <= s.GiorniPreavviso)
                            {
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-clock-fill"></i> Imminente
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-primary">
                                    <i class="bi bi-calendar-check"></i> Attiva
                                </span>
                            }
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <a asp-controller="Scadenze" asp-action="Details" asp-route-id="@s.Id" 
                                   class="btn btn-outline-info" title="Dettaglio">
                                    <i class="bi bi-eye"></i>
                                </a>
                                @if (!s.IsCompletata)
                                {
                                    <button type="button"
                                            class="btn btn-outline-success"
                                            title="Completa"
                                            onclick="completaScadenzaTab('@s.Id', '@lottoId')">
                                        <i class="bi bi-check"></i>
                                    </button>
                                }
                                <a asp-controller="Scadenze" asp-action="Edit" asp-route-id="@s.Id" 
                                   class="btn btn-outline-warning" title="Modifica">
                                    <i class="bi bi-pencil"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info mb-0">
        <i class="bi bi-info-circle"></i>
        Nessuna scadenza registrata per questo lotto.
        <a asp-controller="Scadenze" asp-action="Create" asp-route-lottoId="@lottoId" class="alert-link">
            Aggiungi la prima scadenza
        </a>
    </div>
}
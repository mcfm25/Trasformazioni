@model Trasformazioni.Models.ViewModels.RegistroContrattiEditViewModel
@using Trasformazioni.Models.Enums
@{
    var tipoDescrizione = Model.TipoRegistro == TipoRegistro.Preventivo ? "Preventivo" : "Contratto";
    ViewData["Title"] = $"Modifica {tipoDescrizione}";
}

<div class="container py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                <div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <span class="badge @Model.TipoBadgeClass fs-6">@Model.TipoRegistroDescrizione</span>
                        <span class="badge @Model.StatoBadgeClass fs-6">
                            <i class="@Model.StatoIcon me-1"></i>@Model.StatoDescrizione
                        </span>
                    </div>
                    <h2>@ViewData["Title"]</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                            <li class="breadcrumb-item"><a asp-action="Index">Registro Contratti</a></li>
                            <li class="breadcrumb-item">
                                <a asp-action="Details" asp-route-id="@Model.Id">
                                    @(string.IsNullOrWhiteSpace(Model.NumeroProtocollo) ? "Dettaglio" : Model.NumeroProtocollo)
                                </a>
                            </li>
                            <li class="breadcrumb-item active" aria-current="page">Modifica</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left me-1"></i> Torna ai dettagli
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Stato -->
    @if (!Model.CanChangeStato)
    {
        <div class="alert alert-warning mb-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Questo documento è in stato <strong>@Model.StatoDescrizione</strong>. Alcune modifiche potrebbero essere limitate.
        </div>
    }

    @if (Model.HasChildren)
    {
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle me-2"></i>
            Questo documento ha <strong>versioni successive</strong> (rinnovi). Le modifiche non influenzeranno i documenti derivati.
        </div>
    }

    <form asp-action="Edit" method="post" id="registroForm">
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="Stato" />
        <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

        <div class="row">
            <!-- Colonna Principale -->
            <div class="col-lg-8">
                <!-- Dati Identificativi -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>Dati Identificativi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Tipo Registro -->
                            <div class="col-md-4">
                                <label asp-for="TipoRegistro" class="form-label">Tipo <span class="text-danger">*</span></label>
                                @if (Model.CanChangeTipo)
                                {
                                    <select asp-for="TipoRegistro" asp-items="Model.TipiRegistroSelectList"
                                            class="form-select" required>
                                    </select>
                                }
                                else
                                {
                                    <input type="hidden" asp-for="TipoRegistro" />
                                    <div class="form-control-plaintext">
                                        <span class="badge @Model.TipoBadgeClass">@Model.TipoRegistroDescrizione</span>
                                        <small class="text-muted d-block">Non modificabile</small>
                                    </div>
                                }
                                <span asp-validation-for="TipoRegistro" class="text-danger"></span>
                            </div>

                            <!-- Numero Protocollo -->
                            <div class="col-md-4">
                                <label asp-for="NumeroProtocollo" class="form-label">Numero Protocollo</label>
                                <input asp-for="NumeroProtocollo" class="form-control"
                                       placeholder="Es: PROT-2024-001" maxlength="50" />
                                <span asp-validation-for="NumeroProtocollo" class="text-danger"></span>
                                <small id="protocollo-validation-message" class="form-text"></small>
                            </div>

                            <!-- ID Riferimento Esterno -->
                            <div class="col-md-4">
                                <label asp-for="IdRiferimentoEsterno" class="form-label">ID Rif. Esterno</label>
                                <input asp-for="IdRiferimentoEsterno" class="form-control"
                                       placeholder="Identificativo esterno..." maxlength="100" />
                                <span asp-validation-for="IdRiferimentoEsterno" class="text-danger"></span>
                            </div>

                            <!-- Categoria -->
                            <div class="col-md-6">
                                <label asp-for="CategoriaContrattoId" class="form-label">Categoria <span class="text-danger">*</span></label>
                                <select asp-for="CategoriaContrattoId" asp-items="Model.CategorieSelectList"
                                        class="form-select" required>
                                    <option value="">-- Seleziona categoria --</option>
                                </select>
                                <span asp-validation-for="CategoriaContrattoId" class="text-danger"></span>
                            </div>

                            <!-- Responsabile -->
                            <div class="col-md-6">
                                <label asp-for="UtenteId" class="form-label">Responsabile Interno</label>
                                <select asp-for="UtenteId" asp-items="Model.UtentiSelectList" class="form-select">
                                    <option value="">-- Seleziona responsabile --</option>
                                </select>
                                <span asp-validation-for="UtenteId" class="text-danger"></span>
                            </div>

                            <!-- Oggetto -->
                            <div class="col-12">
                                <label asp-for="Oggetto" class="form-label">Oggetto <span class="text-danger">*</span></label>
                                <input asp-for="Oggetto" class="form-control"
                                       placeholder="Descrizione sintetica del contratto/preventivo"
                                       maxlength="500" required />
                                <span asp-validation-for="Oggetto" class="text-danger"></span>
                            </div>

                            @* <!-- Descrizione -->
                            <div class="col-12">
                                <label asp-for="Descrizione" class="form-label">Descrizione</label>
                                <textarea asp-for="Descrizione" class="form-control" rows="3"
                                          placeholder="Descrizione dettagliata (opzionale)" maxlength="2000"></textarea>
                                <span asp-validation-for="Descrizione" class="text-danger"></span>
                            </div> *@
                        </div>
                    </div>
                </div>

                <!-- Controparte -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-building me-2"></i>Controparte
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Cliente da Anagrafica -->
                            <div class="col-md-8">
                                <label asp-for="ClienteId" class="form-label">Cliente (da anagrafica)</label>
                                <select asp-for="ClienteId" asp-items="Model.ClientiSelectList"
                                        class="form-select" id="clienteSelect">
                                    <option value="">-- Seleziona cliente o inserisci manualmente --</option>
                                </select>
                                <span asp-validation-for="ClienteId" class="text-danger"></span>
                            </div>

                            <!-- Tipo Controparte -->
                            <div class="col-md-4">
                                <label asp-for="TipoControparte" class="form-label">Tipo</label>
                                <select asp-for="TipoControparte" asp-items="Model.NatureGiuridicheSelectList"
                                        class="form-select" id="tipoControparteSelect">
                                    <option value="">-- Seleziona --</option>
                                </select>
                                <span asp-validation-for="TipoControparte" class="text-danger"></span>
                            </div>

                            <!-- Ragione Sociale Manuale -->
                            <div class="col-12">
                                <label asp-for="RagioneSociale" class="form-label">Ragione Sociale</label>
                                <input asp-for="RagioneSociale" class="form-control"
                                       placeholder="Inserisci manualmente se non presente in anagrafica"
                                       maxlength="200" id="ragioneSocialeInput" />
                                <span asp-validation-for="RagioneSociale" class="text-danger"></span>
                                <small class="form-text text-muted">
                                    Compilato automaticamente se selezioni un cliente dall'anagrafica
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date e Scadenze -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar3 me-2"></i>Date e Scadenze
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Data Documento -->
                            <div class="col-md-4">
                                <label asp-for="DataDocumento" class="form-label">Data Documento <span class="text-danger">*</span></label>
                                <input asp-for="DataDocumento" type="date" class="form-control" required />
                                <span asp-validation-for="DataDocumento" class="text-danger"></span>
                            </div>

                            <!-- Data Decorrenza -->
                            <div class="col-md-4">
                                <label asp-for="DataDecorrenza" class="form-label">Data Decorrenza</label>
                                <input asp-for="DataDecorrenza" type="date" class="form-control" />
                                <span asp-validation-for="DataDecorrenza" class="text-danger"></span>
                            </div>

                            <!-- Data Fine / Scadenza -->
                            <div class="col-md-4">
                                <label asp-for="DataFineOScadenza" class="form-label">Data Scadenza</label>
                                <input asp-for="DataFineOScadenza" type="date" class="form-control" />
                                <span asp-validation-for="DataFineOScadenza" class="text-danger"></span>
                            </div>

                            <!-- Date Invio/Accettazione (readonly se valorizzate) -->
                            @if (Model.DataInvio.HasValue)
                            {
                                <div class="col-md-4">
                                    <label class="form-label">Data Invio</label>
                                    <div class="form-control-plaintext">
                                        <i class="bi bi-calendar-check me-1"></i>
                                        @Model.DataInvio.Value.ToString("dd/MM/yyyy")
                                    </div>
                                </div>
                            }
                            @if (Model.DataAccettazione.HasValue)
                            {
                                <div class="col-md-4">
                                    <label class="form-label">Data Accettazione</label>
                                    <div class="form-control-plaintext">
                                        <i class="bi bi-calendar-check me-1"></i>
                                        @Model.DataAccettazione.Value.ToString("dd/MM/yyyy")
                                    </div>
                                </div>
                            }

                            <!-- Preavviso Disdetta -->
                            <div class="col-md-4">
                                <label asp-for="GiorniPreavvisoDisdetta" class="form-label">Preavviso Disdetta (giorni)</label>
                                <input asp-for="GiorniPreavvisoDisdetta" type="number" class="form-control"
                                       min="0" max="365" placeholder="Es: 30" />
                                <span asp-validation-for="GiorniPreavvisoDisdetta" class="text-danger"></span>
                            </div>

                            <!-- Alert Scadenza -->
                            <div class="col-md-4">
                                <label asp-for="GiorniAlertScadenza" class="form-label">Alert Scadenza (giorni prima)</label>
                                <input asp-for="GiorniAlertScadenza" type="number" class="form-control"
                                       min="0" max="365" placeholder="Es: 60" />
                                <span asp-validation-for="GiorniAlertScadenza" class="text-danger"></span>
                            </div>

                            <!-- Durata Calcolata -->
                            <div class="col-md-4">
                                <label class="form-label">Durata</label>
                                <div class="form-control-plaintext" id="durataCalcolata">
                                    <span class="text-muted">--</span>
                                </div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Rinnovo Automatico -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check form-switch">
                                    <input asp-for="IsRinnovoAutomatico" class="form-check-input"
                                           type="checkbox" role="switch" id="rinnovoAutomaticoSwitch" />
                                    <label asp-for="IsRinnovoAutomatico" class="form-check-label">
                                        Rinnovo Automatico
                                    </label>
                                </div>
                                <small class="form-text text-muted">
                                    Se attivo, il contratto verrà rinnovato automaticamente alla scadenza
                                </small>
                            </div>
                            <div class="col-md-6" id="giorniRinnovoContainer">
                                <label asp-for="GiorniRinnovoAutomatico" class="form-label">Durata Rinnovo (giorni)</label>
                                <input asp-for="GiorniRinnovoAutomatico" type="number" class="form-control"
                                       min="1" max="3650" placeholder="Es: 365" />
                                <span asp-validation-for="GiorniRinnovoAutomatico" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Importi -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-currency-euro me-2"></i>Importi
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <!-- Canone Annuo -->
                            <div class="col-md-4">
                                <label asp-for="ImportoCanoneAnnuo" class="form-label">Canone Annuo</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input asp-for="ImportoCanoneAnnuo" type="number" step="0.01"
                                           class="form-control" placeholder="0.00" min="0" />
                                </div>
                                <span asp-validation-for="ImportoCanoneAnnuo" class="text-danger"></span>
                            </div>

                            <!-- Una Tantum -->
                            <div class="col-md-4">
                                <label asp-for="ImportoUnatantum" class="form-label">Una Tantum</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input asp-for="ImportoUnatantum" type="number" step="0.01"
                                           class="form-control" placeholder="0.00" min="0" />
                                </div>
                                <span asp-validation-for="ImportoUnatantum" class="text-danger"></span>
                            </div>

                            <!-- Totale (calcolato, readonly) -->
                            <div class="col-md-4">
                                <label class="form-label">Importo Totale</label>
                                <div class="input-group">
                                    <span class="input-group-text">€</span>
                                    <input type="text" class="form-control bg-light" id="importoTotaleDisplay"
                                           value="@Model.ImportoTotale.ToString("N2")" readonly />
                                </div>
                                <small class="form-text text-muted">Calcolato automaticamente</small>
                            </div>
                        </div>
                    </div>
                </div>

                @* <!-- Note -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-sticky me-2"></i>Note
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-0">
                            <textarea asp-for="Note" class="form-control" rows="3"
                                      placeholder="Note interne (opzionale)" maxlength="2000"></textarea>
                            <span asp-validation-for="Note" class="text-danger"></span>
                        </div>
                    </div>
                </div> *@
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Info e Azioni -->
                <div class="card border-0 shadow-sm mb-4 sticky-top" style="top: 1rem;">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>Informazioni
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Stato Attuale -->
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1">Stato Attuale</label>
                            <div>
                                <span class="badge @Model.StatoBadgeClass fs-6">
                                    <i class="@Model.StatoIcon me-1"></i>@Model.StatoDescrizione
                                </span>
                            </div>
                            <small class="text-muted">
                                Per cambiare stato, usa le azioni dalla pagina dei dettagli
                            </small>
                        </div>

                        <!-- Info Documento Padre -->
                        @if (Model.ParentId.HasValue)
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted small mb-1">Documento Originale</label>
                                <div>
                                    <a asp-action="Details" asp-route-id="@Model.ParentId" class="text-decoration-none">
                                        <i class="bi bi-link me-1"></i>
                                        @(Model.ParentNumeroProtocollo ?? Model.ParentOggetto ?? "Visualizza")
                                    </a>
                                </div>
                            </div>
                        }

                        <!-- Versioni Successive -->
                        @if (Model.HasChildren)
                        {
                            <div class="mb-3">
                                <label class="form-label text-muted small mb-1">Versioni Successive</label>
                                <div>
                                    <span class="badge bg-info">
                                        <i class="bi bi-diagram-3 me-1"></i>Ha rinnovi
                                    </span>
                                </div>
                            </div>
                        }

                        <!-- Allegati -->
                        <div class="mb-3">
                            <label class="form-label text-muted small mb-1">Allegati</label>
                            <div class="d-flex align-items-center gap-2">
                                <span class="badge bg-secondary">@Model.NumeroAllegati</span>
                                <a asp-action="Upload" asp-route-id="@Model.Id" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-plus-lg me-1"></i>Aggiungi
                                </a>
                            </div>
                        </div>

                        <hr>

                        <!-- Pulsanti Azione -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-lg me-2"></i>Salva Modifiche
                            </button>
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                                <i class="bi bi-x-lg me-2"></i>Annulla
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Link Rapidi -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent">
                        <h5 class="mb-0">
                            <i class="bi bi-lightning me-2"></i>Azioni Rapide
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                                <i class="bi bi-eye me-2"></i>Visualizza Dettagli
                            </a>
                            <a asp-action="Upload" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                                <i class="bi bi-paperclip me-2"></i>Gestisci Allegati
                            </a>
                            @if (Model.Stato == StatoRegistro.Attivo ||
                                                        Model.Stato == StatoRegistro.InScadenza ||
                                                        Model.Stato == StatoRegistro.InScadenzaPropostoRinnovo)
                            {
                                <a asp-action="Rinnova" asp-route-id="@Model.Id" class="btn btn-outline-info">
                                    <i class="bi bi-arrow-repeat me-2"></i>Rinnova Contratto
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        $(document).ready(function () {
            const registroId = '@Model.Id';
            const dataDecorrenzaInput = $('#DataDecorrenza');
            const dataScadenzaInput = $('#DataFineOScadenza');
            const rinnovoSwitch = $('#rinnovoAutomaticoSwitch');
            const giorniRinnovoContainer = $('#giorniRinnovoContainer');
            const protocolloInput = $('#NumeroProtocollo');
            const protocolloMessage = $('#protocollo-validation-message');

            // Ricalcolo importo totale
            function updateImportoTotale() {
                const canone = parseFloat($('#importoCanone').val()) || 0;
                const unaTantum = parseFloat($('#importoUnaTantum').val()) || 0;
                const totale = canone + unaTantum;
                $('#importoTotaleDisplay').val(totale.toLocaleString('it-IT', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }));
            }
            $('#importoCanone, #importoUnaTantum').on('input', updateImportoTotale);

            // Inizializzazione
            toggleGiorniRinnovo();
            updateDurataCalcolata();

            // Toggle giorni rinnovo
            function toggleGiorniRinnovo() {
                if (rinnovoSwitch.is(':checked')) {
                    giorniRinnovoContainer.show();
                } else {
                    giorniRinnovoContainer.hide();
                }
            }
            rinnovoSwitch.on('change', toggleGiorniRinnovo);

            // Calcolo durata
            function updateDurataCalcolata() {
                const dataDecorrenza = dataDecorrenzaInput.val();
                const dataScadenza = dataScadenzaInput.val();
                const durataEl = $('#durataCalcolata');

                if (dataDecorrenza && dataScadenza) {
                    const d1 = new Date(dataDecorrenza);
                    const d2 = new Date(dataScadenza);
                    const diffTime = d2 - d1;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays > 0) {
                        const years = Math.floor(diffDays / 365);
                        const months = Math.floor((diffDays % 365) / 30);
                        const days = diffDays % 30;

                        let durataText = '';
                        if (years > 0) durataText += years + ' ann' + (years > 1 ? 'i' : 'o') + ' ';
                        if (months > 0) durataText += months + ' mes' + (months > 1 ? 'i' : 'e') + ' ';
                        if (days > 0 && years === 0) durataText += days + ' giorn' + (days > 1 ? 'i' : 'o');

                        durataEl.html('<span class="text-success">' + durataText.trim() + ' (' + diffDays + ' gg)</span>');
                    } else {
                        durataEl.html('<span class="text-danger">Date non valide</span>');
                    }
                } else {
                    durataEl.html('<span class="text-muted">--</span>');
                }
            }
            dataDecorrenzaInput.on('change', updateDurataCalcolata);
            dataScadenzaInput.on('change', updateDurataCalcolata);

            // Validazione numero protocollo (escludendo ID corrente)
            let protocolloTimeout;
            protocolloInput.on('blur', function () {
                const protocollo = $(this).val().trim();
                if (!protocollo) {
                    protocolloMessage.text('').removeClass('text-success text-danger');
                    return;
                }

                clearTimeout(protocolloTimeout);
                protocolloTimeout = setTimeout(function () {
                    $.ajax({
                        url: '@Url.Action("CheckNumeroProtocollo")',
                        data: {
                            numeroProtocollo: protocollo,
                            excludeId: registroId
                        },
                        success: function (response) {
                            if (response === true) {
                                protocolloMessage.text('✓ Disponibile').removeClass('text-danger').addClass('text-success');
                            } else {
                                protocolloMessage.text('✗ ' + response).removeClass('text-success').addClass('text-danger');
                            }
                        }
                    });
                }, 300);
            });
            protocolloInput.on('input', function () {
                protocolloMessage.text('').removeClass('text-success text-danger');
            });

            // Validazione form
            $('#registroForm').on('submit', function (e) {
                const dataDecorrenza = dataDecorrenzaInput.val();
                const dataScadenza = dataScadenzaInput.val();

                if (dataDecorrenza && dataScadenza) {
                    if (new Date(dataScadenza) < new Date(dataDecorrenza)) {
                        e.preventDefault();
                        alert('La data di scadenza non può essere precedente alla data di decorrenza.');
                        dataScadenzaInput.focus();
                        return false;
                    }
                }

                // Verifica rinnovo automatico
                if (rinnovoSwitch.is(':checked')) {
                    const giorniRinnovo = $('#GiorniRinnovoAutomatico').val();
                    if (!giorniRinnovo || giorniRinnovo <= 0) {
                        e.preventDefault();
                        alert('Se il rinnovo automatico è attivo, specificare i giorni di rinnovo.');
                        $('#GiorniRinnovoAutomatico').focus();
                        return false;
                    }
                }
            });
        });
    </script>
}